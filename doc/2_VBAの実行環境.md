# 2 VBA の実行環境

VBA は、VBA 環境と呼ばれる特定の実行環境内で発生した処理を実行するプログラムを定義するためのプログラミング言語である。VBA 環境は通常、ホストアプリケーションと呼ばれる別のコンピュータアプリケーションによって制御される。ホストアプリケーションは、そのホストされた VBA 環境内の計算プロセスを制御して呼び出す。また、ホストアプリケーションは、VBA プログラムがホストアプリケーションのデータおよび計算プロセスにアクセスできるように、ホストされた VBA 環境内の計算リソースを利用可能にすることができる。このセクションの残りの部分では、VBA 環境の主要な計算コンセプトを定義する。

## 2.1 データ値とデータ型

VBA 環境では情報はデータ値として表現される。データ値はそのような要素の特定の有限領域の単一の要素である。VBA 環境ではさまざまなデータ型を定義している。これらのデータ型は、VBA の値の範囲を集合的に定義する。各データ型は、この仕様で定義される固有の特性を持つ。VBA 環境内の各データ値は、これらのデータ型の 1 つのメンバである。個々の値は不変である。これは、VBA 環境内でデータ値を別のデータ値に変更するための仕組みが存在しないことを意味する。データ値は不変なので、特定のデータ値の複数のコピーが VBA 環境内に存在することができ、そのようなコピーは論理的にすべて同じデータといえる。

VBA 環境のデータ型は以下の表で定義される。基準表現とは、VBA の型の当初の設計基準として使用された表現である。

実装では、これらの特定の型表現を使用して、本仕様の要求事項を満たすことができる。

| データ型名 | 要素の範囲 | 規格 |
| ---- | ---- | ---- |
| Boolean | True, False | 16 ビット符号付き整数<br>/2 の補数表現で 0 (False) または -1 (True) の値を取る。 |
| Byte | 0 ～ 255 の整数値 | 8 ビット符号なし整数。 |
| Currency | 小数部を 4 桁持つ以下の範囲の数値<br/>-922,337,203,685,477.5808 ～ +922,337,203,685,477.5807 | 64 ビット符号付き整数。<br/>暗黙的に 10 の -4 乗の精度にされる。 |
| Date | 西暦100年1月1日 ～ 西暦9999年12月31日までの小数部を含む日数 | 8 バイト浮動小数点数 [（IEEE 754-1985）](https://go.microsoft.com/fwlink/?LinkId=89903)。<br/>浮動小数点値。0.0 はエポック日付/時刻を表し、1899/12/30 00:00:00 である。その他の日付は、エポックより前の日数（負の値）または後の日数（正の値）で表される。小数部は日の端数（時刻）を表す。 |
| Decimal | スケールされた以下の範囲の整数値<br/>±79,228,162,514,264,337,593,543,950,335<br/>この数値は、10 の 0 ～ -28 乗の範囲でスケーリング<ins>してもよい</ins> | 符号ビットと 96 ビットの符号なし整数部の分子を含む 14 バイトのデータ構造で表される有理数。分母は 1 バイトにエンコードされた 0 から 28 の範囲の指数を持つ 10 の冪乗の値。 |
| Double | ゼロ、NaN、無限大、有効な IEEE 754-1985 の倍精度浮動小数点数のすべて | IEEE 754-1985 の 64 ビットハードウェア実装。 |
| Integer | -32,768 ～ 32,767 の範囲の整数値 | 16 ビットの 2 の補数表現 |
| Long | -2,147,483,648 ～ 2,147,486,647 の範囲の整数値 | 32 ビットの 2 の補数表現 |
| LongLong | -9,223,372,036,854,775,808 ～ 9,223,372,036,854,775,807 の範囲の整数値 | 64 ビットの 2 の補数表現 |
| オブジェクト参照 | ホストアプリケーションまたはプログラムによって作成されたオブジェクトの一意な識別子と、予約済みの識別子 `Nothing` に対応する識別値 | メモリアドレス 0 番地は `Nothing` を表すために予約されている。 |
| Single | ゼロ、NaN、無限大、有効な IEEE 754-1985 の単精度浮動小数点数のすべて | IEEE 754-1985 の 32 ビットハードウェア実装。 |
| String（可変長） | 長さ 0 の空文字列と、実装依存の文字集合を使用して考えられるすべての文字列。文字列の長さは実装による制限があってもよいが、その制限は (2 ^ 16 - 10) 文字以下と<ins>する必要がある</ins>。 | 16 ビットバイナリ符号化された Unicode コードポイントのシーケンス。 |
| String*n（固定長） | 1 ～ 65,526 の範囲の長さの文字列 | 1 ～ 64K (2 ^ 16 - 10) 文字程度。 |
| Empty | 予約済みの識別子 `Empty` に対応する単一の識別値 | 実装固有のビットパターン。 |
| Error | 0 ～ 65,535 までの標準エラーコードと、その他の実装定義のエラー値。実装定義のエラー値はその値が必要なコンテキスト（`CInt` など）で 0 ～ 65535 の標準エラーコードに解決可能。 |
| Null | 予約済みの識別子 `Null` に対応する単一の識別値 | 実装固有のビットパターン。 |
| Missing | 明示的に宣言されたオプションパラメーターに、対応する値が渡されなかったことを示すために使用される単一の識別値 | 実装固有のビットパターン。 |
| 配列型 | 最大60次元までの、多次元の数値インデックス付きのデータ値の集合。次元を持たない空集合も含まれる。この集合は、同じ種類（集合の全要素（2.1.1 項）が同じデータ型を持つ）、または異なる種類（要素のデータ型が無関係）である可能性がある。各次元の要素は、符号付き整数の連続したシーケンスによって識別（インデックス付け）される。ある次元の最小インデックス値はその次元の下限、最大インデックス値はその次元の上限である。下限と上限が等しい場合もある。 | データ値を行優先で線形に連結したもの。<br/>個々のデータ値の間に実装定義のパディングが含まれる場合がある。 |
| ユーザー定義型（UDT） | 異なるデータ型を持つ可能性のある名前付きのデータ値の集合。各 UDT データ値は、そのデータ型として機能する特定の名前付き UDT 宣言と関連付けられる。 | データ値を線形に連結したもので、データ値の間に実装定義のパディングが含まれる場合がある。 |

VBA 言語には、`Enum` と呼ばれる追加された種類の型と見られるものを定義する構文がある。`Enum` 特有のデータ型は無く、その代わり `Enum` のメンバは `Long` で表される。

VBA 実装は、参照されるライブラリのプロシージャから戻り値として取得できる他の実装定義のデータ型を<ins>含めてもよい</ins>。VBA 環境内の文や式で使用する場合の値のセマンティクスは実装定義である。

### 2.1.1 集合データ値

特定の配列または特定の UDT 名のいずれかのデータ型（セクション 2.1）を持つデータ値（セクション 2.1）は集合データ値である。オブジェクト参照は集合データ値ではないことに注意。集合データ値は、それぞれが集合内の個々の値に対応する 0 以上の要素から構成される。いくつかの状況では、要素自体がそれ自身の要素を持つ集合データ値である。

集合データ値の各要素は、それ自体がデータ値であり対応するデータ型を持つ。要素のデータ型はその要素自身の型となる。配列データ値は同じ要素型を持つが、UDT データ値の要素は異なるデータ型を持つことができる。

## 2.2 エンティティと宣言型

 エンティティは、名前またはインデックスによってアクセスできる VBA 環境のコンポーネントで、単純な名前式、インデックス式、およびメンバーアクセス式の解決規則に従う。エンティティには、プロジェクト、手続きモジュール、型（クラスモジュール、UDT、Enums、組み込み型）、プロパティ、関数、サブルーチン、イベント、変数、リテラル、定数、条件定数などがある。

多くの種類のエンティティでは、現在のコンテキストからアクセス可能なエンティティを参照することのみが有効である。アクセシビリティが変化する可能性のあるエンティティは、そのエンティティに固有の後方セクションでアクセシビリティレベルが定義される。

ほとんどのエンティティは、関連する宣言型を持っている。宣言型は、変数（セクション 2.3）が含むことのできるデータ値（セクション 2.1）を制限するものである。宣言型は、他の言語実体に関連付けられる可能性のあるデータ値を制限するためにも使用される。一般に宣言型は、データ型（セクション 2.1）に従ってデータ値を制限する。

次の表は、VBA の宣言型を定義したものである。VBA 環境内のすべてのデータ値はこれらの宣言型のいずれかを持ち、宣言型に適合するデータ値のみを含むように制限される。

| 宣言型 | データ値の制限 |
| ------ | -------- |
| Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String | 宣言型と同じ名前のデータ型を持つデータ値のみ。次の点に注意すること。<br/><li>Decimal は有効な宣言型ではない。</li><li>LongLong は 64 ビット演算をサポートする VBA 実装上でのみ有効な宣言型。</li> |
| Variant | 制限なし。一般にあらゆるデータ値とあらゆるデータ型を持つ。しかし、コンテキストによっては Variant 宣言されたデータ型は取り得るデータ値やデータ型のサブセットに明示的に制限されることがある。 |
| String*n （n は 1 ～ 65,526 の整数） | データ型が String で文字数がちょうど n であるデータ値のみ。 |
| 宣言された要素型が Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String, String*n, 特定のクラス名, UDT 名のいずれかである固定長配列 | 同じデータ型の配列データ値で、以下の制約に適合するもののみ。<br/><li>各要素のデータ型（セクション 2.1）がその変数の宣言された要素のデータ型と同じである。変数の要素型が特定のクラス名である場合、各要素は `Nothing` への参照か、データ型がオブジェクト参照であり名前付き要素クラスのインスタンス（セクション 2.5）であるオブジェクトか、名前付きクラスの公開インタフェースに適合するオブジェクトのいずれかを識別するデータ値（セクション 2.5）で<ins>なければならない</ins>。</li><li>次元数が変数の次元数と同じである。</li><li>上限値と下限値（セクション 2.1）が、値と変数の各次元について同じである。</li> |
| 宣言された要素型が Variant である固定長配列 | 配列型のデータ値であり、以下の制約に適合するもののみ。<br/></li><li>次元数が変数の次元数と同じである。</li><li>上限値と下限値が、値と変数の各次元について同じである。</li> |
| 宣言された要素型が Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String, String*n, 特定のクラス名, UDT 名のいずれかである可変長配列 | 各要素のデータ型が、変数の宣言された要素型と同じである配列のみ。変数の宣言型が特定のクラス名である場合、各要素は `Nothing` への参照か、データ型がオブジェクト参照であり名前付き要素クラスのインスタンスであるオブジェクトか、名前付きクラスの公開インタフェースに適合するオブジェクトのいずれかを識別するデータ値で<ins>なければならない</ins>。 |
| 宣言された要素型が Variant である可変長配列 | 配列型のデータ値のみ。 |
| 特定のクラス名 | `Nothing` への参照か、データ型がオブジェクト参照であり名前付き要素クラスのインスタンスであるオブジェクトか、名前付きクラスの公開インタフェースに適合するオブジェクトのいずれかを識別する値。 |
| 特定の UDT 名 | 特定の名前付き UTD 型のデータ値のみ。 |

データ型と同様、`Enum` 固有の宣言型は存在しない。その代わり、`Enum` 型は `Long` 宣言型であるとみなされる。このような `Enum` 宣言には特別なデータ値の制限はなく、指定された `Enum` 型のメンバーとして存在するものだけでなく任意の `Long` データ値を含むことができることに注意。

実装定義の `LongPtr` の型エイリアスも定義されており、実装がポインタやハンドルの値を保持するために使用する基準の宣言型にマッピングされる。32 ビットの実装では `LongPtr` を `Long` に、64 ビットの実装では `LongPtr` を `LongLong` にマッピング<ins>する必要がある</ins>が、`LongPtr` を実装定義のポインタ型にマッピング<ins>してもよい</ins>。`LongPtr` の型エイリアスは、その基準となる宣言型が有効であればどこでも有効である。

配列と UDT を除くすべての宣言型はスカラー宣言型である。

## 2.3 変数

VBA 環境での変数はデータ値（セクション 2.1）の変更可能なコンテナである。個々のデータ値は不変であり、プログラムの実行中に変わることはないが、特定の変数が含むデータ値はプログラムの実行中に何度も入れ替わる可能性がある。

特定の変数は、VBA プログラム上のテキスト、ホストアプリケーション、または本仕様のいずれかによって定義される。変数の定義には、その変数の宣言型（セクション 2.2）の指定が含まれる。

変数には、作成される、プログラムによって使用可能になる、破棄されるという、明確なライフサイクルがある。変数が作成されてから破棄されるまでの期間を変数のエクステントと呼ぶ。作成と破棄の時期を共有する変数は、同じエクステントを共有していると言える。変数のエクステントはその定義方法によって異なり、取り得るエクステントは次の表で定義される。

| エクステント名 | 変数定義の書式 | 変数の生存期間 |
| ---- | ---- | ---- |
| プログラムエクステント | VBA 仕様またはホストアプリケーションによって定義される | アクティブな VBA 環境すべて。 |
| モジュールエクステント | モジュール変数の宣言、またはプロシージャ内の静的ローカル変数の宣言 | アクティブな VBA プロジェクトにモジュールが組み込まれた時点から、モジュールまたはプロジェクトが明示的または暗黙的にその VBA 環境から削除されるまでの期間。 |
| プロシージャエクステント | プロシージャのローカル変数またはパラメータの宣言 | 特定のプロシージャが呼び出されている期間。 |
| オブジェクトエクステント | クラスモジュールの変数の宣言 | その変数が含まれるオブジェクトの生存期間。 |
| 集合エクステント | 配列または UDT 変数の従属変数（セクション 2.3.1） | その変数が含まれるデータ値集合（セクション 2.1.1）を保持する変数の生存期間。 |

変数が作成されるとデフォルト値で初期化される。変数のデフォルト値は次の表に従い、変数の宣言型によって決定される。

| 宣言型 | 初期値 |
| ---- | ---- |
| Boolean | `Flase` |
| Byte, Currency, Double, Integer, Long, LongLong | 対応するデータ型（セクション 2.1）の 0 |
| Double, Single | 対応するデータ型の +0.0 |
| Date | 1899/12/30 00:00:00 |
| String | 空文字列 |
| Variant | `Empty` |
| String*n （n は 1 ～ 65,526 の整数） | Unicode コードポイント U+0000 に対応する null 文字の実装依存表現のみからなる長さ n の文字列 |
| 宣言された要素型が Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String, String*n, 特定のクラス名, UDT 名のいずれかである固定長配列 | 次元数および境界が宣言された配列と同じであり、各要素が宣言された要素型のデフォルト値である配列値 |
| 宣言された要素型が Variant である固定長配列 |次元数および境界が宣言された配列と同じであり、各要素が `Empty` である配列値 |
| 宣言された要素型が Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String, String*n, 特定のクラス名, UDT 名のいずれかである可変長配列 | 次元なしの配列値 |
| 宣言された要素型が Variant である可変長配列 | 次元なしの配列値 |
| 特定のクラス名 | `Nothing` |
| 特定の UDT 名 | すべての名前付き要素がその宣言型に適した初期値を持つ、名前付き UDT データ値 |

変数には一般的に 1 つの変数名があり、VBA プログラム内でその変数を識別するために使用される。しかし、変数名は処理上何の意味も持たない。プロシージャ呼び出しの参照パラメータとして変数を使用するような状況では、1 つの変数に複数の名前が関連付けられる場合がある。VBA プログラム内からの変数へのアクセスは、変数名の可視性スコープによって決定される。一般に、変数名の可視性は変数のエクステントと密接に関連するが、変数名のスコープ自体には処理上の意味はない。

### 2.3.1 集合変数

集合データ値（セクション 2.1.1）を含む変数（セクション 2.3）を集合変数という。集合変数は，各々が現在の集合データ値の要素（セクション 2.1.1）に対応する従属変数で構成される。各従属変数が含むデータ値は、それを含む集合データ値の対応する要素データ値である。状況によっては、従属変数自体がそれ自身の従属変数を持つ集合データ値を保持することもある。従属変数には名前がなく、配列の場合はインデックス式、UDT の場合はメンバアクセス式でアクセスする。

新しいデータ値が従属変数に割り当てられると、この従属変数を含む集合データ値を保持する集合変数は新しい集合データ値に置き換えられるが、変更された従属変数に対応するデータ値が代わりのデータ値になること以外は、それ以前のデータ値と同じとなる。その集合データ値自体が更に別の従属変数に含まれている場合、この処理は従属変数でない集合変数に到達するまで繰り返される。

## 2.4 プロシージャ

プロシージャは、VBA 環境内のアルゴリズム機能の単位である。ほとんどのプロシージャは VBA 言語を使って定義されるが、VBA 環境には本仕様で定義される標準プロシージャも含まれており、ホストアプリケーションによって実装定義で提供されるプロシージャや外部定義ライブラリからインポートされたプロシージャを含むこともできる。プロシージャは、その宣言の一部であるプロシージャ名によって識別される。

VBA には、同一のモジュール（セクション 4.2）内に定義された同じ名称のプロシージャの集合であるプロパティという概念もある。このようなプロシージャの集合要素へは、プロパティ名を変数名（セクション 2.3）のように直接参照することでアクセスすることができる。どのプロシージャが呼び出されるかは、プロパティ名を参照するコンテキストによって決定される。

VBA 環境は、メインプロシージャの呼び出しから始まり完了まで途切れることなく続く単独のプログラムを実行することに限定されない。代わりに、VBA は変数、プロシージャ、オブジェクトに反応する環境を提供する。ホストアプリケーションは、ホストされている VBA 環境内のプロシージャを呼び出すことによって処理を開始する。このようなプロシージャは、他のプロシージャを呼び出した後、最終的にホストアプリケーションに制御を返す場合がある。しかし、VBA 環境は、開始した呼び出しの制御がホストアプリケーションに戻った後も、その状態（ほとんどの変数とオブジェクトの内容を含む）を保持する。その後、ホストアプリケーションはその VBA 環境内の同じプロシージャや他のプロシージャを呼び出すことができる。また、プロシージャは VBA 環境による明示的な呼び出しに加えて、ホストアプリケーションが提供するオブジェクトに関連したイベント（セクション 2.5）から呼び出すこともできる。

## 2.5 オブジェクト

VBA 環境では、オブジェクトとは、関連する変数（セクション 2.3）、プロシージャ（セクション 2.4）、イベントの集合体である。オブジェクトを構成する変数、プロシージャ、イベントを総称して、オブジェクトのメンバと呼ぶ。メソッドという用語は、プロシージャメンバと同じ意味で使用することができる。各オブジェクトは、データ型（セクション 2.1）がオブジェクト参照のデータ値（セクション 2.1）である一意な識別子によって識別される。オブジェクトのメンバにアクセスするには、このオブジェクト参照を用いて、メソッドを呼び出したりメンバ変数やプロパティを評価したりする。特定のデータ値は同時に多くの変数に存在することができるため、特定のオブジェクトにアクセスする方法は数多く存在する。

オブジェクトのイベントは、特別な名称のプロシージャを動的に関連付けることができるアタッチメントポイントである。このとき、プロシージャはオブジェクトのイベントを処理すると表現される。VBA 言語の `RaiseEvent` ステートメントを使用すると、オブジェクトのメソッドは、どのプロシージャが関連付けされていかを知らなくても、オブジェクトのイベントを処理するプロシージャを呼び出すことができる。

オブジェクトを構成するすべての変数とイベントは、オブジェクトが明示的または暗黙的に作成されたときに開始し、すべての手続きからアクセスできなくなったときに終了する同じエクステント（セクション 2.3）を持っている。

クラスとは、同じプロシージャを共有して同一の変数とイベントを持つオブジェクトの集合を宣言的に記述したものである。このようなオブジェクトの集合のメンバーは、クラスのインスタンスと呼ばれる。一般的にクラスは複数のインスタンスを持つことができるが、VBA ではそのインスタンスを 1 つに限定したクラスの定義も可能である。特定のクラスのすべてのインスタンスは、クラスが提供する変数とイベントの宣言を共有しているが、各インスタンスはそれらの宣言に対応する独自の変数とイベントを持っている。

VBA 言語で宣言されるアクセス制御オプションは、クラスにより定義された各オブジェクトメンバへのアクセスを、VBA 環境内のどのプロシージャに許可するのかを制限することができる。すべてのプロシージャからアクセス可能なメンバは公開メンバと呼ばれ、クラスのすべての公開プロシージャと公開変数はまとめてクラスの公開インタフェースと呼ばれる。クラスの定義では、クラス自身の公開インターフェースに加えて、1 つ以上の他のクラスの公開インターフェースを実装することを明示的に記述することができる。公開インタフェースを実装するように明示的に定義されたクラスまたはオブジェクトは、そのインタフェースに適合していると表現される。この場合、適合するクラスはそれが実装するすべての公開インタフェースの公開プロシージャと公開変数のすべてについて明示的にタグ付けされた定義を<ins>含まなければならない</ins>。

あるクラスの名前を宣言型（セクション 2.2）とした変数が定義されている場合、その変数は、そのクラスのインスタンスへのオブジェクト参照、またはそのクラスの公開インターフェースに適合するオブジェクトへのオブジェクト参照のみ含めることができる。

### 2.5.1 オブジェクトの自動インスタンス化

クラス（セクション 2.5）の名称を宣言型（セクション 2.2）として宣言された変数（セクション 2.3）は、`New` キーワード（セクション 3.3.5.1）により自動インスタンス化変数に指定することができる。自動インスタンス化変数にアクセスしたときその変数の現在のデータ値が `Nothing` であると、その都度、クラスの新しいインスタンス（セクション 2.5）が生成された後で変数に格納されて、それがアクセスされた値として使用されることになる。
