# 2 VBA の実行環境

VBA は、VBA 環境と呼ばれる特定の実行環境内で発生した処理を実行するプログラムを定義するためのプログラミング言語である。VBA 環境は通常、ホストアプリケーションと呼ばれる別のコンピュータアプリケーションによって制御される。ホストアプリケーションは、そのホストされた VBA 環境内の計算プロセスを制御して呼び出す。また、ホストアプリケーションは、VBA プログラムがホストアプリケーションのデータおよび計算プロセスにアクセスできるように、ホストされた VBA 環境内の計算リソースを利用可能にすることができる。このセクションの残りの部分では、VBA 環境の主要な計算コンセプトを定義する。

## 2.1 データ値とデータ型

VBA 環境では情報はデータ値として表現される。データ値はそのような要素の特定の有限領域の単一の要素である。VBA 環境ではさまざまなデータ型を定義している。これらのデータ型は、VBA の値の範囲を集合的に定義する。各データ型は、この仕様で定義される固有の特性を持つ。VBA 環境内の各データ値は、これらのデータ型の 1 つのメンバである。個々の値は不変である。これは、VBA 環境内でデータ値を別のデータ値に変更するための仕組みが存在しないことを意味する。データ値は不変なので、特定のデータ値の複数のコピーが VBA 環境内に存在することができ、そのようなコピーは論理的にすべて同じデータといえる。

VBA 環境のデータ型は以下の表で定義される。基準表現とは、VBA の型の当初の設計基準として使用された表現である。

実装では、これらの特定の型表現を使用して、本仕様の要求事項を満たすことができる。

| データ型名 | 要素の範囲 | 規格 |
| ---- | ---- | ---- |
| Boolean | True, False | 16 ビット符号付き整数<br>/2 の補数表現で 0 (False) または -1 (True) の値を取る。 |
| Byte | 0 ～ 255 の整数値 | 8 ビット符号なし整数。 |
| Currency | 小数部を 4 桁持つ以下の範囲の数値<br/>-922,337,203,685,477.5808 ～ +922,337,203,685,477.5807 | 64 ビット符号付き整数。<br/>暗黙的に 10 の -4 乗の精度にされる。 |
| Date | 西暦100年1月1日 ～ 西暦9999年12月31日までの小数部を含む日数 | 8 バイト浮動小数点数 [（IEEE 754-1985）](https://go.microsoft.com/fwlink/?LinkId=89903)。<br/>浮動小数点値。0.0 はエポック日付/時刻を表し、1899年12月30日午前0時である。その他の日付は、エポックより前の日数（負の値）または後の日数（正の値）で表される。小数部は日の端数（時刻）を表す。 |
| Decimal | スケールされた以下の範囲の整数値<br/>±79,228,162,514,264,337,593,543,950,335<br/>この数値は、10 の 0 ～ -28 乗の範囲でスケーリング<ins>してもよい</ins> | 符号ビットと 96 ビットの符号なし整数部の分子を含む 14 バイトのデータ構造で表される有理数。分母は 1 バイトにエンコードされた 0 から 28 の範囲の指数を持つ 10 の冪乗の値。 |
| Double | ゼロ、NaN、無限大、有効な IEEE 754-1985 の倍精度浮動小数点数のすべて | IEEE 754-1985 の 64 ビットハードウェア実装。 |
| Integer | -32,768 ～ 32,767 の範囲の整数値 | 16 ビットの 2 の補数表現 |
| Long | -2,147,483,648 ～ 2,147,486,647 の範囲の整数値 | 32 ビットの 2 の補数表現 |
| LongLong | -9,223,372,036,854,775,808 ～ 9,223,372,036,854,775,807 の範囲の整数値 | 64 ビットの 2 の補数表現 |
| オブジェクト参照 | ホストアプリケーションまたはプログラムによって作成されたオブジェクトの一意な識別子と、予約済みの識別子 `Nothing` に対応する識別値 | メモリアドレス 0 番地は `Nothing` を表すために予約されている。 |
| Single | ゼロ、NaN、無限大、有効な IEEE 754-1985 の単精度浮動小数点数のすべて | IEEE 754-1985 の 32 ビットハードウェア実装。 |
| String（可変長） | 長さ 0 の空文字列と、実装依存の文字集合を使用して考えられるすべての文字列。文字列の長さは実装による制限があってもよいが、その制限は (2 ^ 16 - 10) 文字以下と<ins>する必要がある</ins>。 | 16 ビットバイナリ符号化された Unicode コードポイントのシーケンス。 |
| String*n（固定長） | 1 ～ 65,526 の範囲の長さの文字列 | 1 ～ 64K (2 ^ 16 - 10) 文字程度。 |
| Empty | 予約済みの識別子 `Empty` に対応する単一の識別値 | 実装固有のビットパターン。 |
| Error | 0 ～ 65,535 までの標準エラーコードと、その他の実装定義のエラー値。実装定義のエラー値はその値が必要なコンテキスト（`CInt` など）で 0 ～ 65535 の標準エラーコードに解決可能。 |
| Null | 予約済みの識別子 `Null` に対応する単一の識別値 | 実装固有のビットパターン。 |
| Missing | 明示的に宣言されたオプションパラメーターに、対応する値が渡されなかったことを示すために使用される単一の識別値 | 実装固有のビットパターン。 |
| 配列型 | 最大60次元までの、多次元の数値インデックス付きのデータ値の集合。次元を持たない空集合も含まれる。この集合は、同じ種類（集合の全要素（2.1.1 項）が同じデータ型を持つ）、または異なる種類（要素のデータ型が無関係）である可能性がある。各次元の要素は、符号付き整数の連続したシーケンスによって識別（インデックス付け）される。ある次元の最小インデックス値はその次元の下限、最大インデックス値はその次元の上限である。下限と上限が等しい場合もある。 | データ値を行優先で線形に連結したもの。<br/>個々のデータ値の間に実装定義のパディングが含まれる場合がある。 |
| ユーザー定義型（UDT） | 異なるデータ型を持つ可能性のある名前付きのデータ値の集合。各 UDT データ値は、そのデータ型として機能する特定の名前付き UDT 宣言と関連付けられる。 | データ値を線形に連結したもので、データ値の間に実装定義のパディングが含まれる場合がある。 |

VBA 言語には、`Enum` と呼ばれる追加された種類の型と見られるものを定義する構文がある。`Enum` 特有のデータ型は無く、その代わり `Enum` のメンバは `Long` で表される。

VBA 実装は、参照されるライブラリのプロシージャから戻り値として取得できる他の実装定義のデータ型を<ins>含めてもよい</ins>。VBA 環境内の文や式で使用する場合の値のセマンティクスは実装定義である。

### 2.1.1 データ値集合

特定の配列または特定の UDT 名のいずれかのデータ型（セクション 2.1）を持つデータ値（セクション 2.1）はデータ値集合である。オブジェクト参照はデータ値集合ではないことに注意。データ値集合は、それぞれが集合内の個々の値に対応する 0 以上の要素から構成される。いくつかの状況では、要素自体がそれ自身の要素を持つデータ値集合である。

データ値集合の各要素は、それ自体がデータ値であり対応するデータ型を持つ。要素のデータ型はその要素自身の型となる。配列データ値は同じ要素型を持つが、UDT データ値の要素は異なるデータ型を持つことができる。

## 2.2 エンティティと宣言型

 エンティティは、名前またはインデックスによってアクセスできる VBA 環境のコンポーネントで、単純な名前式、インデックス式、およびメンバーアクセス式の解決規則に従う。エンティティには、プロジェクト、手続きモジュール、型（クラスモジュール、UDT、Enums、組み込み型）、プロパティ、関数、サブルーチン、イベント、変数、リテラル、定数、条件定数などがある。

多くの種類のエンティティでは、現在のコンテキストからアクセス可能なエンティティを参照することのみが有効である。アクセシビリティが変化する可能性のあるエンティティは、そのエンティティに固有の後方セクションでアクセシビリティレベルが定義される。

ほとんどのエンティティは、関連する宣言型を持っている。宣言型は、変数（セクション 2.3）が含むことのできるデータ値（セクション 2.1）を制限するものである。宣言型は、他の言語実体に関連付けられる可能性のあるデータ値を制限するためにも使用される。一般に宣言型は、データ型（セクション 2.1）に従ってデータ値を制限する。

次の表は、VBA の宣言型を定義したものである。VBA 環境内のすべてのデータ値はこれらの宣言型のいずれかを持ち、宣言型に適合するデータ値のみを含むように制限される。

| 宣言型 | データ値の制限 |
| ------ | -------- |
| Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String | 宣言型と同じ名前のデータ型を持つデータ値のみ。次の点に注意すること。<br/><li>Decimal は有効な宣言型ではない。</li><li>LongLong は 64 ビット演算をサポートする VBA 実装上でのみ有効な宣言型。</li> |
| Variant | 制限なし。一般にあらゆるデータ値とあらゆるデータ型を持つ。しかし、コンテキストによっては Variant 宣言されたデータ型は取り得るデータ値やデータ型のサブセットに明示的に制限されることがある。 |
| String*n （n は 1 ～ 65,526 の整数） | データ型が String で文字数がちょうど n であるデータ値のみ。 |
| 宣言された要素型が Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String, String*n, 特定のクラス名, UDT 名のいずれかである固定長配列 | 同じデータ型の配列データ値で、以下の制約に適合するもののみ。<br/><li>各要素のデータ型（セクション 2.1）がその変数の宣言された要素のデータ型と同じである。変数の要素型が特定のクラス名である場合、各要素は `Nothing` への参照か、データ型がオブジェクト参照であり名前付き要素クラスのインスタンス（セクション 2.5）であるオブジェクトか、名前付きクラスの公開インタフェースに適合するオブジェクトのいずれかを識別するデータ値（セクション 2.5）で<ins>なければならない</ins>。</li><li>次元数が変数の次元数と同じである。</li><li>上限値と下限値（セクション 2.1）が、値と変数の各次元について同じである。</li> |
| 宣言された要素型が Variant である固定長配列 | 配列型のデータ値であり、以下の制約に適合するもののみ。<br/></li><li>次元数が変数の次元数と同じである。</li><li>上限値と下限値が、値と変数の各次元について同じである。</li> |
| 宣言された要素型が Boolean, Byte, Currency, Date, Double, Integer, Long, LongLong, Object, Single, String, String*n, 特定のクラス名, UDT 名のいずれかである可変長配列 | 各要素のデータ型が、変数の宣言された要素型と同じである配列のみ。変数の宣言型が特定のクラス名である場合、各要素は `Nothing` への参照か、データ型がオブジェクト参照であり名前付き要素クラスのインスタンスであるオブジェクトか、名前付きクラスの公開インタフェースに適合するオブジェクトのいずれかを識別するデータ値で<ins>なければならない</ins>。 |
| 宣言された要素型が Variant である可変長配列 | 配列型のデータ値のみ。 |
| 特定のクラス名 | `Nothing` への参照か、データ型がオブジェクト参照であり名前付き要素クラスのインスタンスであるオブジェクトか、名前付きクラスの公開インタフェースに適合するオブジェクトのいずれかを識別する値。 |
| 特定の UDT 名 | 特定の名前付き UTD 型のデータ値のみ。 |

データ型と同様、`Enum` 固有の宣言型は存在しない。その代わり、`Enum` 型は `Long` 宣言型であるとみなされる。このような `Enum` 宣言には特別なデータ値の制限はなく、指定された `Enum` 型のメンバーとして存在するものだけでなく任意の `Long` データ値を含むことができることに注意。

実装定義の `LongPtr` の型エイリアスも定義されており、実装がポインタやハンドルの値を保持するために使用する基準の宣言型にマッピングされる。32 ビットの実装では `LongPtr` を `Long` に、64 ビットの実装では `LongPtr` を `LongLong` にマッピング<ins>する必要がある</ins>が、`LongPtr` を実装定義のポインタ型にマッピング<ins>してもよい</ins>。`LongPtr` の型エイリアスは、その基準となる宣言型が有効であればどこでも有効である。

配列と UDT を除くすべての宣言型はスカラー宣言型である。

## 2.3 変数
